Notes=Backbone.Model.extend({initialize:function(){this.set("zoomLevel",1),this.totalDaysAtZoomLevel=[92,190,370],this.scopeStartDate=moment().subtract(45,"days"),this.scopeEndDate=this.scopeStartDate.clone().add(90,"days"),this.afterCreateNote=_.bind(this.afterCreateNote,this),this.afterUpdateNote=_.bind(this.afterUpdateNote,this),this.setUserName=_.bind(this.setUserName,this),GlobalEvent.listenTo("user-info-fetched",this.setUserName)},connect:function(e,t){this.migrationNeeded=t,this.storage=e?new FirebaseStorage(this):new DemoStorage(this),this.storage.authenticate()},setUserName:function(e){this.set("username",e.detail.name),this.migrationNeeded&&migration.start()},setScopeBasedOnZoomLevel:function(){var e=this.get("zoomLevel"),t=this.totalDaysAtZoomLevel[e-1]/2,a=this.scopeStartDate.clone().add(this.scopeEndDate.diff(this.scopeStartDate,"days")/2,"days");this.scopeStartDate=a.clone().subtract(t,"days"),this.scopeEndDate=a.clone().add(t,"days")},getDateRangeInScope:function(){return[this.scopeStartDate.toDate(),this.scopeEndDate.toDate()]},adjustDatesInScope:function(e){this.scopeStartDate.add(e,"days"),this.scopeEndDate.add(e,"days")},getMarkersInScope:function(){return this.get("markers")},getDateTicksInScope:function(){for(var e=[],t=this.scopeStartDate.clone().startOf("day"),a=this.get("zoomLevel");t.isBefore(this.scopeEndDate);)e.push(t.clone().toDate()),t.add(1,1==a?"days":"weeks");return e},getMonthsInScope:function(){for(var e=this.scopeStartDate.clone().startOf("month"),t=[];e.isBefore(this.scopeEndDate);)t.push([e.clone().toDate(),e.clone().endOf("month").endOf("day").toDate()]),e.add(1,"month");return t},getNoteTypes:function(){return _.sortBy(_.uniq(_.map(this.get("events"),function(e){return e.type})),function(e){return e})},getNotesInScope:function(){var e=this,t=_.filter(this.get("events"),function(t){var a=moment(t.date);return a.isAfter(e.scopeStartDate)&&a.isBefore(e.scopeEndDate)}),a=_.groupBy(t,function(e){return e.type}),s=this.getNoteTypes(),o=[];return _.each(s,function(e){o.push([e,a[e]||[]])}),o},deleteNote:function(e){this.storage.deleteNote(e)},addNote:function(e,t,a){var s=t.toLowerCase().trim(),o={content:e,type:s,date:a.toDate()};this.storage.createNote(o)},afterCreateNote:function(e){this.get("events").push(e),GlobalEvent.trigger("refresh")},afterUpdateNote:function(e){var t=_.filter(this.get("events"),function(t){return t.type==e.type&&moment(t.date).isSame(e.date,"day")});t[0].content=e.content},afterDeleteNote:function(e){var t=this.get("events");_.each(t,function(a,s){_.isEqual(a,e)&&delete t[s]}),GlobalEvent.trigger("refresh")},addMarker:function(e,t){var a={label:e,date:t};this.storage.createMarker(a)},afterAddMarker:function(e){this.get("markers").push(e),this.trigger("change:markers",e)},afterUpdateMarker:function(e){var t=_.filter(this.get("markers"),function(e){return moment(e.date).isSame(e.date,"day")});t[0].label=e.label,this.trigger("change:markers",e)},deleteMarker:function(e){this.storage.deleteMarker(e)},afterDeleteMarker:function(e){var t=this.get("markers");_.each(t,function(a,s){a.id==e.id&&delete t[s]}),this.set("markers",_.compact(t))},zoom:function(e){var t=this.get("zoomLevel");e&&t>1?(this.set("zoomLevel",t-1),this.setScopeBasedOnZoomLevel(),this.trigger("change:scope")):!e&&3>t&&(this.set("zoomLevel",t+1),this.setScopeBasedOnZoomLevel(),this.trigger("change:scope"))},getUserName:function(e){return this.storage.getUserName(e)}});