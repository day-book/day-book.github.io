function FirebaseStorage(e){function t(e){var t=[];return _.forEach(e,function(e,n){t.push({date:moment(n,a),label:e.label})}),t}function n(e){var t=[];return _.forEach(e,function(e,n){_.forEach(e,function(e,r){t.push({date:moment(n,a),type:r,content:e.content})})}),t}var a="YYYY-MM-DD",r=this;r.model=e,this.init=function(){r.ref=new Firebase("https://kurippu.firebaseio.com")},this.authenticate=function(){var e=r.ref.getAuth();null==e?r.ref.authWithOAuthPopup("google",function(e,t){e?(alert("Login Failed! Try Again"),console.error("Login failed",e)):(r.user=t,r.loadData(),r.fetchUserName())}):(r.user=e,r.fetchUserName(),r.loadData())},this.fetchUserName=function(){GlobalEvent.trigger("user-info-fetched",{name:r.user.google.displayName})},this.loadData=function(){this.loadMarkers(),this.loadEvents()},this.loadMarkers=function(){var e=r.ref.child(r.user.uid+"/markers");e.once("value",function(e){var n=t(e.val());r.model.set("markers",n)})},this.createMarker=function(e,t){var n=moment(e.date).format(a),o=r.ref.child(r.user.uid+"/markers/"+n);o.once("value",function(n){n.exists()?(e.label=e.label+", "+n.val().label,t||r.model.afterUpdateMarker(e)):t||r.model.afterAddMarker(e),o.update({label:e.label})})},this.bulkCreateMarkers=function(e){_.forEach(e,function(e){r.createMarker(e,!0)})},this.deleteMarker=function(e){var t=moment(e.date).format(a),n=r.ref.child(r.user.uid+"/markers/"+t);n.remove(),r.model.afterDeleteMarker(e)},this.loadEvents=function(){var e=r.ref.child(r.user.uid+"/notes");e.once("value",function(e){var t=n(e.val());r.model.set("events",t)})},this.createNote=function(e,t,n){var o=moment(e.date).format(a),i=r.ref.child(r.user.uid+"/notes/"+o+"/"+e.type);i.once("value",function(a){a.exists()?(e.content=n?e.content:e.content+"\n\n"+a.val().content,i.update({content:e.content}),t||r.model.afterAmendNote(e)):(i.update({content:e.content}),t||r.model.afterCreateNote(e))})},this.bulkCreateNotes=function(e){_.forEach(e,function(e){r.createNote(e,!0)})},this.deleteNote=function(e){var t=moment(e.date).format(a),n=r.ref.child(r.user.uid+"/notes/"+t+"/"+e.type);n.remove(),r.model.afterDeleteNote(e)},this.updateUserConfig=function(e){var t=r.ref.child(r.user.uid+"/config");t.update(e)},this.fetchUserConfig=function(e,t){var n=r.ref.child(r.user.uid+"/config");n.once("value",function(n){n.exists()?t(n.val()[e]):t(void 0)})},this.init()}