TimeSliderView=Backbone.View.extend({initialize:function(){this.d3el=d3.select(this.el),this.timeScale=d3.time.scale(),this.noteTypeColor=_.bind(this.noteTypeColor,this),this.handleDelete=_.bind(this.handleDelete,this),this.handleAdd=_.bind(this.handleAdd,this),this.registerGlobalListeners(),$(".note-popup .delete").on("click",this.handleDelete),$(".new-note-popup .save").on("click",this.handleAdd),$(".close").on("click",this.closePopup),this.listenTo(this.model,"change:scope",this.refresh),this.listenTo(this.model,"change:events",this.refresh)},registerGlobalListeners:function(){var e=this;this.d3el.call(d3.behavior.drag().on("dragstart",function(){e.dragStartPosition=d3.event.x}).on("drag",function(){var t=moment(e.timeScale.invert(e.dragStartPosition)),n=moment(e.timeScale.invert(d3.event.x)),o=t.diff(n,"days");o+=n.isAfter(t)?-1:1,e.dragStartPosition=d3.event.x,e.slideTimeline(o)})),this.d3el.on("mousemove",function(){var t=[{x:d3.event.x,y:d3.event.y}],n=e.d3el.selectAll(".pointer").data(t);n.enter().append("rect").classed("pointer",!0),n.exit().remove(),n.attr("x",function(t){var n=moment(e.timeScale.invert(t.x));return e.timeScale(n.startOf("day").add(12,"hours").toDate())-1}).attr("y",60).attr("width",1).attr("height",e.$el.height())})},slideTimeline:function(e){$(".note-popup").hide(),$(".new-note-popup").hide(),this.model.adjustDatesInScope(e),this.refresh()},refresh:function(){this.drawTimeline(),this.drawNoteTypes(),this.drawNotes()},drawTimeline:function(){var e=this;this.timeScale=d3.time.scale().domain(this.model.getDateRangeInScope()).range([0,this.$el.width()+10]);var t=this.model.getDateTicksInScope(),n=this.d3el.selectAll(".tick").data(t),o=n.enter().append("g").classed("tick",!0);o.append("rect"),o.append("text"),n.exit().remove(),n.select("rect").attr("x",function(t){return e.timeScale(t)}).attr("y",0).attr("width",function(){return e.$el.width()/t.length}).attr("height",60).classed("saturday",function(e){return 6==moment(e).isoWeekday()}).classed("sunday",function(e){return 7==moment(e).isoWeekday()}).classed("today",function(e){return moment(e).format()==moment().startOf("day").format()}),n.select("text").attr("x",function(t){return e.timeScale(t)+3}).attr("y",55).style("font-size",function(){return.6*(e.$el.width()/t.length)+"px"}).text(function(e){return moment(e).format("DD")});var i=this.d3el.selectAll(".tick-month").data(this.model.getMonthsInScope()),a=i.enter().append("g").classed("tick-month",!0);a.append("rect"),a.append("text"),i.exit().remove(),i.select("rect").attr("x",function(t){return e.timeScale(t[0])}).attr("y",0).attr("width",function(t){return e.timeScale(t[1])-e.timeScale(t[0])}).attr("height",18),i.select("text").attr("x",function(t){return e.timeScale(t[0])}).attr("y",14).text(function(e){return"| "+moment(e[0]).format("MMMM YYYY")})},noteTypeScale:function(e){var t=this.model.getNoteTypes().indexOf(e);return 80+75*(t+1)},noteTypeColor:function(e){var t=this.model.getNoteTypes().indexOf(e),n=["#2ca02c","#ff7f0e","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf","#1f77b4"];return n[t]},drawNoteTypes:function(){var e=this,t=this.d3el.selectAll(".note-type").data(this.model.getNoteTypes()),n=t.enter().append("g").classed("note-type",!0);n.append("rect"),n.append("text"),t.exit().remove(),t.select("rect").attr("x",0).attr("y",function(t){return e.noteTypeScale(t)-1}).attr("width",this.$el.width()).attr("height",1),t.select("text").attr("x",10).attr("y",function(t){return e.noteTypeScale(t)-12}).style("fill",e.noteTypeColor).text(function(e){return e.toUpperCase()})},drawNotes:function(){var e=this,t=(d3.scale.category10(),this.d3el.selectAll(".note").data(this.model.getNotesInScope()));t.enter().append("circle").classed("note",!0),t.exit().remove(),t.attr("cx",function(t){return e.timeScale(moment(t.date).clone().add(12,"hours").toDate())}).attr("cy",function(t){return e.noteTypeScale(t.type)}).attr("r",function(){return 9/e.model.get("zoomLevel")}).style("fill",function(t){return e.noteTypeColor(t.type)}).on("mouseover",function(){d3.select(this).data()[0];d3.selectAll(".note-type").select(function(){})}).on("click",function(){e.showNotesPopup(e,this)})},showNotesPopup:function(e,t){$(".new-note-popup").hide();var n=d3.select(t),o=n.data(),i=d3.select(document.body).selectAll(".note-popup").data(o);i.style("left",function(){return parseInt($(n[0]).attr("cx"))-138+"px"}).style("top",function(){return parseInt($(n[0]).attr("cy"))+37+"px"}).style("width","252px").style("height","140px").style("display","block"),i.select(".content").text(function(e){return e.content}),i.select(".delete").style("background-color",function(t){return e.noteTypeColor(t.type)}),$(".note-popup").data(o[0])},closePopup:function(e){var t=$(e.currentTarget).closest("div");t.hide()},handleDelete:function(e){var t=$(e.target).closest(".note-popup"),n=t.data();this.model.deleteNote(n),t.hide(),this.drawNoteTypes(),this.drawNotes()},showNewNotePopup:function(){$(".new-note-popup").show(),$(".new-note-popup input.tag").val(""),$(".new-note-popup input.date").val(moment().format("DD/MM/YYYY")),$(".new-note-popup textarea").focus(),$(".new-note-popup textarea").val(""),$(".note-popup").hide()},handleAdd:function(){var e=$(".new-note-popup .content"),t=$(".new-note-popup .tag"),n=$(".new-note-popup .date"),o=new moment(n.val(),"DD/MM/YYYY",!0),i=[];_.isEmpty(e.val())&&i.push(e),_.isEmpty(t.val())&&i.push(t),o.isValid()||i.push(n),_.isEmpty(i)?(this.model.addNote(e.val(),t.val(),o),$(".new-note-popup").hide(),this.drawNoteTypes(),this.drawNotes()):($(".new-note-popup *").removeClass("invalid"),_.each(i,function(e){e.addClass("invalid")}))},zoomIn:function(){this.model.zoom(!0)},zoomOut:function(){this.model.zoom(!1)}});