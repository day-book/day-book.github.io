TimeSliderView=Backbone.View.extend({initialize:function(){this.d3el=d3.select(this.el),this.timeScale=d3.time.scale(),this.keyboard=new Keyboard,this.login=_.bind(this.login,this),this.demo=_.bind(this.demo,this),this.handleDelete=_.bind(this.handleDelete,this),this.handleMarkerDelete=_.bind(this.handleMarkerDelete,this),this.handleAdd=_.bind(this.handleAdd,this),this.handleAddMarker=_.bind(this.handleAddMarker,this),this.refresh=_.bind(this.refresh,this),$(".note-popup .delete").on("click",this.handleDelete),$(".marker-popup .delete").on("click",this.handleMarkerDelete),$(".new-note-popup .save").on("click",this.handleAdd),$(".new-marker-popup .save").on("click",this.handleAddMarker),$(".login").on("click",this.login),$(".demo").on("click",this.demo),this.listenTo(this.model,"change:scope",this.refresh),this.listenTo(this.model,"change:events",this.refresh),this.listenTo(this.model,"change:markers",this.drawMarkers),this.listenTo(this.model,"change:username",this.setUserName),GlobalEvent.listenTo("refresh",this.refresh),this.createGroupContainers(),this.registerGlobalListeners(),this.showIntro();var e=this;this.d3el.on("click",function(){e.hideAllOpenPopups()})},createGroupContainers:function(){this.d3el.append("g").classed("mouse-pointer",!0),this.d3el.append("g").classed("month-ticks",!0),this.d3el.append("g").classed("day-ticks",!0),this.d3el.append("g").classed("notes",!0),this.d3el.append("g").classed("markers",!0)},registerGlobalListeners:function(){var e=this;this.d3el.on("mousemove",function(){var t=[{x:d3.event.x,y:d3.event.y}],n=e.d3el.select(".mouse-pointer").selectAll(".pointer").data(t);n.enter().append("rect").classed("pointer",!0),n.exit().remove(),n.attr("x",function(t){var n=moment(e.timeScale.invert(t.x));return NoteVM.x({date:n})}).attr("y",0).attr("width",1).attr("height",EnvironmentVM.availableHeight())})},showIntro:function(){this.model.connect(!1),$(".site").show(),$(".open-banner").show()},login:function(e){$(".open-banner .controls").hide(),$(".open-banner .spinner").show(),$(".floating-login").hide();var t=$(e.currentTarget).hasClass("dropbox");this.model.connect(!0,t),this.enableKeyboardShortcuts()},demo:function(){$(".open-banner").hide(),$(".floating-login").show(),$("#intro").explain()},enableKeyboardShortcuts:function(){this.keyboard.bindAll()},slideTimeline:function(e){this.hideAllOpenPopups(),this.model.adjustDatesInScope(e),this.refresh()},refresh:function(){EnvironmentVM.setBounds(this.$el.width(),this.$el.height()),EnvironmentVM.setDaysScale(this.model.getDateRangeInScope()),EnvironmentVM.setNoteTypesScale(this.model.getNoteTypes()),EnvironmentVM.setZoomLevel(this.model.get("zoomLevel")),this.setUserName(),this.drawTimeline(),this.drawNotes(),$(".popup-caret").remove(),this.drawMarkers(),$(".open-banner").hide()},setUserName:function(){$(".banner .username").html(this.model.get("username"))},drawTimeline:function(){this.timeScale=d3.time.scale().domain(this.model.getDateRangeInScope()).range([0,this.$el.width()+10]);var e=this.model.get("zoomLevel"),t=this.model.getDateTicksInScope(),n=this.d3el.select(".day-ticks").selectAll(".tick").data(t),a=n.enter().append("g").classed("tick",!0);a.append("rect"),a.append("text"),n.exit().remove(),n.select("rect").attr("x",TimelineVM.Day.x).attr("y",TimelineVM.Day.y).attr("width",TimelineVM.Day.width).attr("height",TimelineVM.Day.height).classed("sunday",function(t){return 1==e&&7==moment(t).isoWeekday()}).classed("today",function(t){return 1==e&&moment(t).format()==moment().startOf("day").format()}),n.select("text").attr("x",TimelineVM.DayText.x).attr("y",TimelineVM.DayText.y).style("font-size",TimelineVM.DayText.fontSize).text(TimelineVM.DayText.text);var o=this.d3el.select(".month-ticks").selectAll(".tick-month").data(this.model.getMonthsInScope()),i=o.enter().append("g").classed("tick-month",!0);i.append("rect"),i.append("text"),o.exit().remove(),o.select("rect").attr("x",TimelineVM.Month.x).attr("y",TimelineVM.Month.y).attr("width",TimelineVM.Month.width).attr("height",TimelineVM.Month.height),o.select("text").attr("x",TimelineVM.MonthText.x).attr("y",TimelineVM.MonthText.y).text(TimelineVM.MonthText.text)},drawNotes:function(e){var e=e||this.model.getNotesInScope(),t=this,n=this.d3el.select(".notes"),a=n.selectAll(".region").data([1]);a.enter().append("rect").classed("region",!0),a.attr("x",NotesVM.Region.x).attr("y",NotesVM.Region.y).attr("width",NotesVM.Region.width).attr("height",NotesVM.Region.height).call(d3.behavior.drag().on("dragstart",function(){t.dragStartPosition=d3.event.sourceEvent.x}).on("drag",function(){var e=moment(t.timeScale.invert(t.dragStartPosition)),n=moment(t.timeScale.invert(d3.event.x)),a=e.diff(n,"days");a+=n.isAfter(e)?-1:1,t.dragStartPosition=d3.event.x,t.slideTimeline(a)}));var o=n.selectAll(".note-type").data(e),i=o.enter().append("g").classed("note-type",!0);i.append("rect").classed("lane",!0),i.append("text"),o.exit().remove(),o.select(".lane").attr("x",NoteLaneVM.lane.x).attr("y",NoteLaneVM.lane.y).attr("width",NoteLaneVM.lane.width).attr("height",NoteLaneVM.lane.height),o.select("text").attr("x",NoteLaneVM.label.x).attr("y",NoteLaneVM.label.y).style("fill",NoteLaneVM.label.color).text(NoteLaneVM.label.text);var r=o.selectAll(".note").data(function(e){return e[1]});r.enter().append("circle").classed("note",!0),r.exit().remove(),r.attr("cx",NoteVM.x).attr("cy",NoteVM.y).attr("r",NoteVM.r).style("fill",NoteVM.color).on("click",function(){d3.event.stopPropagation(),t.showNotesPopup(t,this)})},moveNoteType:function(e){{var t=e.data().label;EnvironmentVM.noteTypeScale(t)}},findCollidingNoteType:function(e,t){var n=_.find($(".note-type"),function(n){var a=n.getBBox();return n!=e&&t>=a.y&&t<=a.y+a.height});return d3.select(n)},drawMarkers:function(){var e=this,t=(d3.scale.category10(),this.model.getMarkersInScope()),n=this.d3el.select(".markers").selectAll(".marker").data(t),a=n.enter().append("g").classed("marker",!0);a.append("rect"),a.append("path"),a.append("text"),n.exit().remove(),n.classed("collapsed",!0).attr("transform",MarkerVM.transform),n.select("rect").attr("x",MarkerVM.x).attr("width",MarkerVM.width).attr("y",MarkerVM.y).attr("height",MarkerVM.height).style("fill",MarkerVM.color),n.select("path").attr("transform",MarkerVM.Tag.transform).style("fill",MarkerVM.color).transition().attr("d",MarkerVM.Tag.path),n.select("text").attr("x",MarkerVM.Label.x).attr("y",MarkerVM.Label.y).attr("transform",MarkerVM.Tag.transform).text(MarkerVM.Label.initial),n.on("click",function(t){e.expandMarker(t,e,this)})},expandMarker:function(e,t,n){var n=d3.select(n);n.classed("collapsed",!1),n.select("text").text(MarkerVM.Label.text(e)),n.append("text").classed("del",!0).attr("x",MarkerVM.Delete.x).attr("y",MarkerVM.Delete.y).attr("transform",MarkerVM.Tag.transform).text(MarkerVM.Delete.text).on("click",function(e){t.model.deleteMarker(e)}),n.select("path").transition().attr("d",MarkerVM.Tag.expandedPath)},showNotesPopup:function(e,t){this.hideAllOpenPopups();var n=d3.select(t),a=n.data(),o=d3.select(document.body).selectAll(".note-popup").data(a);o.style("left",NoteVM.Popup.x).style("top",NoteVM.Popup.y).style("width",function(e){return NoteVM.Popup.width(e)+"px"}).style("height",NoteVM.Popup.height).style("display","block"),o.select(".date").text(function(e){return moment(e.date).format("DD MMM YYYY (dddd)")}),o.select(".content").text(function(e){return e.content}),o.select(".delete").style("background-color",NoteVM.color),$(".note-popup").data(a[0]);var i=this.d3el.selectAll(".popup-caret").data(a);i.enter().append("polygon").classed("popup-caret",!0),i.attr("points",NoteVM.Popup.Caret.points).attr("transform",NoteVM.Popup.Caret.transform)},hideAllOpenPopups:function(){$(".popup").hide(),$(".popup-caret").remove()},handleDelete:function(e){var t=$(e.target).closest(".note-popup"),n=t.data();this.model.deleteNote(n),t.hide(),$(".popup-caret").remove()},handleMarkerDelete:function(e){var t=$(e.target).closest(".marker-popup"),n=t.data();this.model.deleteMarker(n),t.hide()},showNewNotePopup:function(){this.hideAllOpenPopups(),$(".popup-caret").remove(),$(".new-note-popup").show(),$(".new-note-popup input.tag").val(""),$(".new-note-popup input.date").val(moment().format("DD/MM/YYYY")),$(".new-note-popup textarea").focus(),$(".new-note-popup textarea").val(""),$(".new-note-popup .tag").autocomplete({source:this.model.getNoteTypes()})},handleAdd:function(){var e=$(".new-note-popup .content"),t=$(".new-note-popup .tag"),n=$(".new-note-popup .date"),a=new moment(n.val(),"DD/MM/YYYY",!0),o=[];_.isEmpty(e.val())&&o.push(e),_.isEmpty(t.val())&&o.push(t),a.isValid()||o.push(n),_.isEmpty(o)?(this.model.addNote(e.val(),t.val(),a),$(".new-note-popup").hide()):($(".new-note-popup *").removeClass("invalid"),_.each(o,function(e){e.addClass("invalid")}))},zoomIn:function(){this.model.zoom(!0)},zoomOut:function(){this.model.zoom(!1)},showNewMarkerPopup:function(){this.hideAllOpenPopups();var e=$(".new-marker-popup");e.find("input.label").val(""),e.find("input.date").val(moment().format("DD/MM/YYYY")),e.show(),e.find(".label").focus()},handleAddMarker:function(){$(".new-marker-popup").hide();var e=$(".new-marker-popup .label"),t=$(".new-marker-popup .date"),n=new moment(t.val(),"DD/MM/YYYY",!0);this.model.addMarker(e.val(),n.toDate())}});