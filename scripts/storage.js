function Storage(e){function t(){var e=d.storageClient.getDatastoreManager();e.openDefaultDatastore(function(e,t){e?vex.dialog.alert("Error opening default datastore: "+e.responseText):(d.datastore=t,n())})}function n(){r(),a()}function a(){var e=o("events");d.model.set("events",e)}function r(){var e=o("markers");d.model.set("markers",e)}function o(e,t){var n=d.datastore.getTable(e).query(t),a=[];return _.each(n,function(e){var t=e.getFields();t.id=e.getId(),a.push(t)}),a}function i(e,t){var n=d.datastore.getTable(e),a=n.insert(t);t.id=a.getId()}function s(e,t){var n=d.datastore.getTable(e),a=n.get(t.id);a.update(t)}function c(e,t){var n=d.datastore.getTable(e),a=n.get(t.id);a.deleteRecord()}var d=this;d.model=e,this.init=function(){d.storageClient=new Dropbox.Client({key:"1eg429deptchqw3"})},this.authenticate=function(){var e=this;d.storageClient.authenticate(function(n){n?vex.dialog.alert("Authentication error: "+n.responseText):(t(),e.fetchUserName())})},this.fetchUserName=function(){return d.storageClient.getAccountInfo(function(e,t){e?vex.dialog.alert("Authentication error: "+e.responseText):GlobalEvent.trigger("user-info-fetched",{name:t.name})})},this.createNote=function(e){var t=o("events",{type:e.type,date:moment(e.date).startOf("day").toDate()});if(1==t.length){var n=t[0].content;t[0].content=n+"\n\n"+e.content,s("events",t[0]),d.model.afterUpdateNote(t[0])}else i("events",e),d.model.afterCreateNote(e)},this.deleteNote=function(e){c("events",{id:e.id}),d.model.afterDeleteNote(e)},this.createMarker=function(e){i("markers",e)},this.deleteMarker=function(e){c("markers",e)},this.init()}