function Storage(e){function t(){var e=a.storageClient.getDatastoreManager();e.openDefaultDatastore(function(e,t){e?alert("Error opening default datastore: "+e):(a.eventsTable=t.getTable("events"),n())})}function n(){var e=a.eventsTable.query(),t=[];_.each(e,function(e){t.push(e.getFields())}),a.model.set("events",t)}var a=this;a.model=e,this.init=function(){a.storageClient=new Dropbox.Client({key:"1eg429deptchqw3"})},this.authenticate=function(){a.storageClient.authenticate(function(e){e?alert("Authentication error: "+e):t()})},this.isAuthenticated=function(){return null!=a.storageClient._oauth._token},this.getUserName=function(e){return a.storageClient.getAccountInfo(function(t,n){t?alert("Authentication error: "+t):e(n.name)})},this.createEvent=function(e){var t=a.eventsTable.query({type:e.type,date:moment(e.date).startOf("day").toDate()});if(1==t.length){var n=t[0].get("content"),i=n+"\n\n"+e.content;t[0].set("content",i);var o=_.filter(a.model.get("events"),function(t){return t.type==e.type&&moment(t.date).isSame(e.date,"day")});o[0].content=i}else a.eventsTable.insert(e),a.model.get("events").push(e)},this.deleteEvent=function(e,t){var n=a.eventsTable.query({id:e.id});n[0].deleteRecord(),_.each(t,function(n,a){n.id==e.id&&delete t[a]})},this.init()}