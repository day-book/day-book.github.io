function Storage(e){function t(){var e=a.storageClient.getDatastoreManager();e.openDefaultDatastore(function(e,t){e?vex.dialog.alert("Error opening default datastore: "+e.responseText):(a.eventsTable=t.getTable("events"),n())})}function n(){var e=a.eventsTable.query(),t=[];_.each(e,function(e){t.push(e.getFields())}),a.model.set("events",t)}var a=this;a.model=e,this.init=function(){a.storageClient=new Dropbox.Client({key:"1eg429deptchqw3"})},this.authenticate=function(){a.storageClient.authenticate(function(e){e?vex.dialog.alert("Authentication error: "+e.responseText):t()})},this.isAuthenticated=function(){return console.log(a.storageClient.isAuthenticated()),null!=a.storageClient._oauth._token},this.getUserName=function(e){return a.storageClient.getAccountInfo(function(t,n){t?vex.dialog.alert("Authentication error: "+t.responseText):e(n.name)})},this.createEvent=function(e){var t=a.eventsTable.query({type:e.type,date:moment(e.date).startOf("day").toDate()});if(1==t.length){var n=t[0].get("content"),o=n+"\n\n"+e.content;t[0].set("content",o);var i=_.filter(a.model.get("events"),function(t){return t.type==e.type&&moment(t.date).isSame(e.date,"day")});i[0].content=o}else a.eventsTable.insert(e),a.model.get("events").push(e)},this.deleteEvent=function(e,t){var n=a.eventsTable.query({id:e.id});n[0].deleteRecord(),_.each(t,function(n,a){n.id==e.id&&delete t[a]})},this.init()}